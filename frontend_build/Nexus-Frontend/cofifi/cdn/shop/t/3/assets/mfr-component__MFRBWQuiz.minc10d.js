window._mfrAlpineRegistered=window._mfrAlpineRegistered||{},window._mfrAlpineRegistered.MFRBWQuiz||(document.addEventListener("alpine:init",()=>{Alpine.data("MFRBWQuiz",({quizID:e,airtableApiKey:t,airtableBaseId:s,resultsPageURL:i,frontPageURL:n})=>({selectors:{page:".quiz-section__page:not(.quiz-section__page-welcome)",section:".mfr-bw__quiz-section"},quizID:e,quiz:Alpine.$persist({answers:{},savedAt:Date.now()}).as(`quiz.${e}`),questions:{},progress:0,loading:!1,resultsPageURL:i,compiledResultsPageURL:`${window.location.origin}${i}`,frontPageURL:n,canStart:!1,animating:!1,airtableApiKey:t,airtableBaseId:s,tables:{QUESTIONS:"Questions",ANSWERS:"Answers",RESPONSES:"Responses"},chunkSize:10,retryCount:3,paceMs:120,pageKeys:[],init(){this.$pages=this.$el.querySelectorAll(this.selectors.page),this.$section=this.$el.closest(this.selectors.section),!this.frontPageURL||this.quiz.canStart&&this.quiz.age||Shopify.designMode||(location.href=this.frontPageURL);try{this.pageKeys=[],this.$el.addEventListener("quiz:register-page",e=>{const t=e?.detail?.key;if(!t)return;this.pageKeys[this.pageKeys.length-1]!==t&&this.pageKeys.push(t);try{this.updatePage()}catch(e){}},{passive:!0})}catch(e){}this.updatePage();try{this.$nextTick(()=>this.updatePage())}catch(e){}},previousPage(){if(this.animating)return null;if(!this.quiz||!this.quiz.answers)return null;const e=Object.keys(this.quiz.answers);if(!e.length)return null;const t=e[e.length-1],s=this.quiz.answers[t],{[t]:i,...n}=this.quiz.answers;return this.quiz.answers=n,this.pruneHiddenAnswers&&this.pruneHiddenAnswers(),this.updatePage(!0),{key:t,value:s}},updatePage(e){const t=this.getVisibleIndexes?this.getVisibleIndexes():[],s=Array.isArray(this.pageKeys)&&this.pageKeys.length>0,i=Object.keys(this.quiz.answers).length;let n=t[i];if(null==n){if(s)return;n=i}const a=null!=n?this.$pages[n]:null;if(a&&!Shopify.designMode)if(this.updateProgress(),e){if(this.animating)return;this.animating=!0;try{fadeOut(this.$pages,()=>{this.$section.scrollIntoView({behavior:"smooth"}),this.$pages.forEach(e=>{e.style.display="none",e.style.opacity="0"}),fadeIn(a),setTimeout(()=>{try{this.$pages.forEach(e=>{e.style.display=e===a?"flex":"none",e.style.opacity=e===a?"1":"0"})}catch(e){}this.animating=!1},200)})}catch(e){this.$pages.forEach(e=>{e.style.display="none",e.style.opacity="0"}),a.style.display="flex",a.style.opacity="1",this.animating=!1}}else this.$section.scrollIntoView({behavior:"smooth"}),this.$pages.forEach(e=>{e.style.display="none",e.style.opacity="0"}),a.style.display="flex",a.style.opacity="1"},updateProgress(){const e=Object.keys(this.quiz.answers).length+1,t=this.getVisibleIndexes&&this.getVisibleIndexes().length||this.$pages.length;this.progress=e/t*100},setAnswer(e,t){if(this.animating)return;this.quiz.answers[e]=t,this.pruneHiddenAnswers&&this.pruneHiddenAnswers();(this.getVisibleIndexes?this.getVisibleIndexes().length:this.$pages.length)>Object.keys(this.quiz.answers).length?this.updatePage(!0):this.finalizeAnswers()},finalizeAnswers(){console.log("All questions have been answered"),this.loading=!0,this.pushSubmission(this.quiz).catch(console.error).finally(e=>{console.log("Data pushed to Airtable"),this.loading=!1,this.updateResultsPageURL(),this.clearQuizCookie(),this.$nextTick(()=>{location.href=this.compiledResultsPageURL})})},setField(e,t){this.quiz[e]=t},handleize:(e="")=>String(e).toLowerCase().trim().replace(/['â€™]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),getOrSetAnswer(e,t){this.quiz||this.getOrSetQuiz(),this.quiz.answers&&"object"==typeof this.quiz.answers||(this.quiz.answers={});const s=this.handleize(e),i=this.quiz.answers[s]||{};return this.quiz.answers={...this.quiz.answers,[s]:{...i,question:e,answer:t}},this.quiz.answers[s]},clearQuizCookie(){const e=`quiz.${this.quizID}`;document.cookie=encodeURIComponent(e)+"=; Max-Age=0; path=/; samesite=lax",this.quiz={age:null,answers:{}}},updateResultsPageURL(){return this.compiledResultsPageURL=`${window.location.origin}${this.resultsPageURL}${this.payloadToQueryString(this.quiz)}`,this.compiledResultsPageURL},payloadToQueryString(e){const t=new URLSearchParams;e.age&&t.set("age",String(e.age)),e.name&&t.set("name",String(e.name));let s=0;const i=e.answers||{};for(const[e,n]of Object.entries(i)){if(!n||"object"!=typeof n)continue;const i=String(n.value??"");t.set(e,i),s+=Number(n.points)||0}return t.set("points",String(s)),`?${t.toString()}`},getTotalPoints(){let e=0;const t=this.quiz.answers||{};for(const[s,i]of Object.entries(t))i&&"object"==typeof i&&(e+=Number(i.points)||0);return e},baseUrl(){return`https://api.airtable.com/v0/${this.airtableBaseId}`},headers(){return{Authorization:`Bearer ${this.airtableApiKey}`,"Content-Type":"application/json"}},sleep:async e=>new Promise(t=>setTimeout(t,e)),async postWithRetry(e,t,s,i){const n=i??this.retryCount??3;for(let i=0;i<=n;i++)try{return await axios.post(e,t,s)}catch(e){const t=e?.response?.status;if(429===t&&i<n){await this.sleep(250*(i+1));continue}throw e}},async apiCreate(e,t,{typecast:s=!0}={}){const i=`${this.baseUrl()}/${encodeURIComponent(e)}${s?"?typecast=true":""}`;return(await this.postWithRetry(i,{fields:t},{headers:this.headers()})).data},async apiCreateMany(e,t,{typecast:s=!0}={}){if(!Array.isArray(t)||0===t.length)return{records:[]};const i=[],n=this.chunkSize??10;for(let a=0;a<t.length;a+=n){const r=t.slice(a,a+n),o=`${this.baseUrl()}/${encodeURIComponent(e)}${s?"?typecast=true":""}`,l=await this.postWithRetry(o,{records:r},{headers:this.headers()});i.push(...l.data.records),a+n<t.length&&await this.sleep(this.paceMs??120)}return{records:i}},async apiCreateQuestionBatch(e){const t=e.map(e=>({fields:{"Question Handle":e.questionKey,"Question String":e.questionString}}));return(await this.apiCreateMany(this.tables.QUESTIONS,t,{typecast:!0})).records},async apiCreateAnswerBatch(e,t){const s=e.map((e,s)=>{const i=String(e.value);return{fields:{"Answer Handle":this.handleize(i),"Answer String":i,Questions:[t[s].id]}}});return(await this.apiCreateMany(this.tables.ANSWERS,s,{typecast:!0})).records},async apiCreateResponseRecord(e,t,s){const i={Questions:e,Points:Number(t)||0};s&&(i.Age=String(s));return await this.apiCreate(this.tables.RESPONSES,i,{typecast:!0})},normalizeSubmission(e){const t=e&&e.answers||{};return Object.values(t).filter(e=>"object"==typeof e&&null!==e&&!0!==e)},async pushSubmission(e){if(!this.airtableApiKey||!this.airtableBaseId)throw new Error("Missing Airtable config. Set airtableApiKey and airtableBaseId.");const t=this.normalizeSubmission(e),s=e?.age?String(e.age):void 0;if(0===t.length)return{createdResponseId:null,createdQuestionIds:[],createdAnswerIds:[],totalPoints:0,age:s};const i=t.reduce((e,t)=>e+(Number(t.points)||0),0),n=await this.apiCreateQuestionBatch(t),a=n.map(e=>e.id),[r,o]=await Promise.all([this.apiCreateAnswerBatch(t,n),this.apiCreateResponseRecord(a,i,s)]);return{createdResponseId:o.id,createdQuestionIds:a,createdAnswerIds:r.map(e=>e.id),totalPoints:i,age:s}},normalizePicked(e){return e?String(e.value??"").split("|").map(e=>this.handleize(e)).filter(Boolean):[]},evaluateCondition(e){if(!e)return!0;const t=this.handleize(e.dependsOn||e.question||"");if(!t)return!0;const s=this.quiz.answers[t];if(!s)return!1;const i=this.normalizePicked(s),n=(e.values||e.answers||[]).map(e=>this.handleize(String(e))),a=String(e.mode||"any").toLowerCase();return"all"===a?n.every(e=>i.includes(e)):"not"===a?n.every(e=>!i.includes(e)):n.some(e=>i.includes(e))},getVisibleIndexes(){const e=[],t=this.pageKeys||[],s=Math.min(t.length,this.$pages?.length||0);for(let i=0;i<s;i++){const s=t[i],n=this.questions[s],a=n&&n.conditional;this.evaluateCondition(a)&&e.push(i)}return e},pruneHiddenAnswers(){try{const e=this.pageKeys||[];if(!e.length)return;const t=(this.getVisibleIndexes?this.getVisibleIndexes():[]).map(t=>e[t]).filter(Boolean);this.quiz.answers=Object.fromEntries(Object.entries(this.quiz.answers).filter(([e])=>t.includes(e)))}catch(e){console.error("pruneHiddenAnswers error",e)}}}))}),window._mfrAlpineRegistered.MFRBWQuiz=!0);
//# sourceMappingURL=mfr-component__MFRBWQuiz.min.js.map

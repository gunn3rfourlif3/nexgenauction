<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/preview-favicon.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nexus Auctions Preview</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; max-width: 640px; }
    .row { display: flex; gap: 1rem; margin-top: .5rem; }
    input { flex: 1; padding: .5rem; }
    button { padding: .5rem 1rem; }
    pre { background: #f7f7f7; padding: 1rem; overflow: auto; }
  </style>
  <script>
    async function login() {
      const email = document.getElementById('email').value || 'artdealer@example.com';
      const password = document.getElementById('password').value || 'password123';
      const base = (localStorage.getItem('API_URL') || 'http://localhost:5006/api');
      const res = await fetch(base + '/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const json = await res.json();
      const token = json.token || json.data?.token;
      const user = json.user || json.data?.user;
      localStorage.setItem('token', token);
      localStorage.setItem('user', JSON.stringify(user));
      document.getElementById('loginOut').textContent = JSON.stringify(json, null, 2);
      document.getElementById('token').textContent = token || '(no token)';
      document.getElementById('userId').textContent = user?._id || '(no user id)';
    }

    async function fetchWatchlist() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const token = localStorage.getItem('token');
      const base = (localStorage.getItem('API_URL') || 'http://localhost:5006/api');
      const url = base + '/auctions?watchedBy=' + encodeURIComponent(user?._id || '');
      const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token }});
      const json = await res.json();
      const auctions = json.data?.auctions || json.auctions || json.items || [];
      document.getElementById('watchOut').textContent = JSON.stringify(auctions, null, 2);
      document.getElementById('watchCount').textContent = auctions.length;
    }

    async function addToWatchlist() {
      const auctionId = document.getElementById('auctionId').value.trim();
      if (!auctionId) { alert('Enter auctionId'); return; }
      const token = localStorage.getItem('token');
      const base = (localStorage.getItem('API_URL') || 'http://localhost:5006/api');
      const res = await fetch(`${base}/auctions/${auctionId}/watchlist`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
      });
      const json = await res.json().catch(() => ({ message: 'non-json response' }));
      document.getElementById('watchActionOut').textContent = `POST /auctions/${auctionId}/watchlist -> ${res.status}\n` + JSON.stringify(json, null, 2);
      if (res.ok || (res.status === 400 && /already/i.test(json.message || ''))) {
        fetchWatchlist();
      }
    }

    async function removeFromWatchlist() {
      const auctionId = document.getElementById('auctionId').value.trim();
      if (!auctionId) { alert('Enter auctionId'); return; }
      const token = localStorage.getItem('token');
      const base = (localStorage.getItem('API_URL') || 'http://localhost:5006/api');
      const res = await fetch(`${base}/auctions/${auctionId}/watchlist`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
      });
      const json = await res.json().catch(() => ({ message: 'non-json response' }));
      document.getElementById('watchActionOut').textContent = `DELETE /auctions/${auctionId}/watchlist -> ${res.status}\n` + JSON.stringify(json, null, 2);
      if (res.ok || (res.status === 400 && /not in/i.test((json.message || '') + (json.error || '')))) {
        fetchWatchlist();
      }
    }

    // --- Catalog preview helpers ---
    function getApiBase() {
      // Prefer relative '/api' when served via preview-server proxy
      try {
        const host = window.location.hostname;
        const port = String(window.location.port || '');
        const devPorts = new Set(['3000','3001','3002','3003','5500']);
        if ((host === 'localhost' || host === '127.0.0.1') && devPorts.has(port)) {
          return '/api';
        }
      } catch {}
      return (localStorage.getItem('API_URL') || 'http://localhost:5006/api');
    }

    function normalizeWatchedBy(arr) {
      if (!Array.isArray(arr)) return [];
      const toStr = (x) => {
        if (!x) return null;
        if (typeof x === 'string') return x;
        if (typeof x === 'object') return x._id || x.id || null;
        return null;
      };
      const strings = arr.map(toStr).filter(Boolean);
      return Array.from(new Set(strings));
    }

    function isWatchedByUser(auction, userId) {
      const watchedBy = normalizeWatchedBy(auction.watchedBy || auction.watchers || []);
      return userId && watchedBy.includes(userId);
    }

    async function fetchAuctionsList() {
      const token = localStorage.getItem('token');
      const base = getApiBase();
      // Use validated params: status=scheduled, sort=startTime asc, limit=12
      const url = `${base}/auctions?status=scheduled&sort=startTime&limit=12&page=1`;
      const res = await fetch(url, { headers: token ? { Authorization: 'Bearer ' + token } : {} });
      const json = await res.json();
      const auctions = json.data?.auctions || json.auctions || [];
      window.previewAuctions = auctions.map(a => ({
        ...a,
        watchedBy: normalizeWatchedBy(a.watchedBy)
      }));
      document.getElementById('auctionsCount').textContent = window.previewAuctions.length;
      renderAuctionsGrid();
    }

    async function toggleWatchlist(auctionId, currentlyWatched) {
      const token = localStorage.getItem('token');
      const base = getApiBase();
      const method = currentlyWatched ? 'DELETE' : 'POST';
      const res = await fetch(`${base}/auctions/${auctionId}/watchlist`, {
        method,
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
      });
      // Best-effort update; re-fetch to reflect authoritative state
      await fetchAuctionsList();
    }

    function renderAuctionsGrid() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const userId = user?._id;
      const container = document.getElementById('auctionsGrid');
      const auctions = window.previewAuctions || [];
      container.innerHTML = '';
      if (!auctions.length) {
        container.innerHTML = '<p>(no auctions found)</p>';
        return;
      }
      const ul = document.createElement('ul');
      ul.style.listStyle = 'none';
      ul.style.padding = '0';
      auctions.forEach(a => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.justifyContent = 'space-between';
        li.style.borderBottom = '1px solid #eee';
        li.style.padding = '.5rem 0';

        const info = document.createElement('div');
        info.innerHTML = `<strong>${a.title || a.name || a._id}</strong> — ${a.currentPrice ? ('$' + a.currentPrice) : ''}`;
        li.appendChild(info);

        const btn = document.createElement('button');
        const watched = isWatchedByUser(a, userId);
        btn.textContent = watched ? '♥' : '♡';
        btn.style.fontSize = '20px';
        btn.style.lineHeight = '20px';
        btn.style.border = 'none';
        btn.style.background = 'transparent';
        btn.style.cursor = 'pointer';
        btn.style.color = watched ? '#e0245e' : '#444';
        btn.title = watched ? 'Remove from watchlist' : 'Add to watchlist';
        btn.addEventListener('click', () => toggleWatchlist(a._id, watched));
        li.appendChild(btn);

        ul.appendChild(li);
      });
      container.appendChild(ul);
    }
  </script>
</head>
<body>
  <h1>Nexus Auctions Preview</h1>
  <div class="card">
    <h2>Login</h2>
    <div class="row">
      <input id="email" placeholder="email" value="artdealer@example.com" />
      <input id="password" placeholder="password" value="password123" />
      <button onclick="login()">Login</button>
    </div>
    <div class="row">
      <div>Token: <code id="token">(none)</code></div>
      <div>UserId: <code id="userId">(none)</code></div>
    </div>
    <pre id="loginOut">(login response)</pre>
  </div>

  <div class="card" style="margin-top:1rem;">
    <h2>Watchlist</h2>
    <div class="row">
      <button onclick="fetchWatchlist()">Fetch Watchlist</button>
      <div>Count: <strong id="watchCount">0</strong></div>
    </div>
    <div class="row">
      <input id="auctionId" placeholder="auction id" value="507f1f77bcf86cd799439012" />
      <button onclick="addToWatchlist()">Add</button>
      <button onclick="removeFromWatchlist()">Remove</button>
    </div>
    <pre id="watchActionOut">(watchlist add/remove response)</pre>
    <pre id="watchOut">(watchlist auctions)</pre>
  </div>

  <div class="card" style="margin-top:1rem;">
    <h2>Auctions Catalog Preview</h2>
    <div class="row">
      <button onclick="fetchAuctionsList()">Fetch Auctions</button>
      <div>Items: <strong id="auctionsCount">0</strong></div>
    </div>
    <div id="auctionsGrid" style="margin-top:.5rem;"></div>
    <small>Tip: Login first so hearts reflect your watchlist.</small>
  </div>
</body>
</html>